version: 2

models:  
  - name: stg_ga4__sessions_traffic_sources_last_non_direct_daily
    description: >
      This model associates the last non-direct traffic acquisition data with the current session. 
      It does this by scanning backwards 30 days from the session date (aka. the lookback window) and looks for the recent non-direct traffic source. 
      This model is incremental, partitioned on session_partition_date, and unique on session_partition_key.
    columns:
      - name: session_partition_key
        tests:
          - unique
      - name: session_source
        description: First non-null source value of the session
        tests:
          - not_null
      - name: last_non_direct_source
        description: The the most recent non-direct traffic source within a 30-day lookback window.
        tests:
          - not_null
      - name: last_non_direct_default_channel_grouping
        description: The the most recent non-direct channel grouping within a 30-day lookback window.
        tests:
          - not_null
# unit_tests:
#   - name: test_stg_ga4__sessions_traffic_sources_last_non_direct_daily
#     description: Test pulling the last non direct session parameters per client_key
#     model: stg_ga4__sessions_traffic_sources_last_non_direct_daily
#     given:
#       - input : ref('stg_ga4__sessions_traffic_sources_daily')
#         format: csv
#         rows: |
#           client_key,session_partition_key,session_partition_date,session_partition_timestamp,session_source,session_medium,session_source_category,session_campaign,session_content,session_term,session_default_channel_grouping,non_direct_session_partition_key
#           A,A,20230505,1683321359,source_a,medium_a,source_category_a,campaign_a,content_a,term_a,default_channel_grouping_a,A
#           A,B,20230506,1683407759,(direct),,,,,,,
#           A,C,20230507,1683494159,source_a,medium_a,source_category_a,campaign_a,content_a,term_a,default_channel_grouping_a,C
#           A,D,20230508,1683580559,(direct),,,,,,,
#     expect: 
#       format: csv
#       rows:
#         client_key,session_partition_key,session_partition_date,session_source,session_medium,session_source_category,session_campaign,session_content,session_term,session_default_channel_grouping,session_partition_key_last_non_direct,last_non_direct_source,last_non_direct_medium,last_non_direct_source_category,last_non_direct_campaign,last_non_direct_content,last_non_direct_term,last_non_direct_default_channel_grouping
#         A,A,20230505,source_a,medium_a,source_category_a,campaign_a,content_a,term_a,default_channel_grouping_a,A,source_a,medium_a,source_category_a,campaign_a,content_a,term_a,default_channel_grouping_a
#         A,B,20230506,(direct),,,,,,,A,source_a,medium_a,source_category_a,campaign_a,content_a,term_a,default_channel_grouping_a
#         A,C,20230507,source_a,medium_a,source_category_a,campaign_a,content_a,term_a,default_channel_grouping_a,C,source_a,medium_a,source_category_a,campaign_a,content_a,term_a,default_channel_grouping_a
#         A,D,20230508,(direct),,,,,,,C,source_a,medium_a,source_category_a,campaign_a,content_a,term_a,default_channel_grouping_a
#     overrides:
#       macros:
#         is_incremental: false
#       vars: {session_attribution_lookback_window_days: 30}
